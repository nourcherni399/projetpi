{% extends 'layouts/admin.html.twig' %}

{% block title %}Recherche mondiale d'événements - AutiCare Admin{% endblock %}

{% block admin_content %}
<div class="max-w-4xl">
    <h1 class="text-2xl font-semibold text-[#4B5563] mb-2">Idées et inspiration pour vos événements</h1>
    <p class="text-[#6B7280] text-sm mb-6">Propositions générées par l’IA et recherche mondiale d’événements à venir.</p>

    {% for message in app.flashes('success') %}
        <div class="mb-4 px-4 py-3 rounded-lg bg-emerald-50 border border-emerald-200 text-emerald-800">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('warning') %}
        <div class="mb-4 px-4 py-3 rounded-lg bg-amber-50 border border-amber-200 text-amber-800">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="mb-4 px-4 py-3 rounded-lg bg-red-50 border border-red-200 text-red-800">{{ message }}</div>
    {% endfor %}

    {# Propositions d'événements (idées IA) — inspiration pour créer un événement #}
    <div id="propositions" class="bg-white rounded-xl border border-[#E5E0D8] overflow-hidden mb-8">
        <div class="p-4 border-b border-[#E5E0D8] bg-[#F5F1EB]">
            <h2 class="text-lg font-semibold text-[#4B5563]">Propositions d’événements (inspiration)</h2>
            <p class="text-sm text-[#6B7280] mt-1">Choisissez une idée pour en faire un brouillon d’événement.</p>
        </div>
        <div class="p-6">
            {% if idees|default([]) is empty %}
                <p class="text-[#6B7280] text-sm">Aucune proposition pour le moment. Utilisez la <strong>Recherche avancée</strong> dans la page Événements, lancez une recherche puis cliquez sur « Générer des idées avec l’IA » pour obtenir des idées ici.</p>
            {% else %}
                <div class="space-y-4">
                    {% for idee in idees %}
                        <div class="border border-[#E5E0D8] rounded-lg p-4 bg-white hover:border-violet-200 transition-colors">
                            <div class="flex flex-wrap items-start justify-between gap-3">
                                <div class="min-w-0 flex-1">
                                    <h3 class="font-medium text-[#4B5563] mb-1">{{ idee.titre }}</h3>
                                    {% if idee.theme %}
                                        <span class="inline-block text-xs px-2 py-0.5 rounded bg-violet-100 text-violet-700">{{ idee.theme }}</span>
                                    {% endif %}
                                    {% if idee.description %}
                                        <p class="text-sm text-[#6B7280] mt-2 line-clamp-2">{{ idee.description }}</p>
                                    {% endif %}
                                    {% if idee.pourquoi %}
                                        <p class="text-xs text-[#9CA3AF] mt-1">{{ idee.pourquoi }}</p>
                                    {% endif %}
                                </div>
                                <a href="{{ path('admin_idees_evenement_creer_brouillon', { id: idee.id }) }}" class="shrink-0 inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-violet-600 text-white text-sm font-medium hover:bg-violet-700 no-underline">
                                    Créer un brouillon d’événement →
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

    <h2 class="text-lg font-semibold text-[#4B5563] mb-2">Recherche mondiale d’événements à venir</h2>
    <p class="text-[#6B7280] text-sm mb-4">Recherchez des événements réels (conférences, ateliers, journées) dans le monde pour la période choisie.</p>

    <div class="bg-white rounded-xl border border-[#E5E0D8] overflow-hidden mb-8">
        <div class="p-6 border-b border-[#E5E0D8]">
            <form method="post" action="{{ path('admin_idees_evenement_search_upcoming') }}" class="flex flex-wrap gap-4 items-end" data-turbo="false">
                <input type="hidden" name="_token" value="{{ csrf_token('admin_idees_evenement_search_upcoming') }}">
                <div class="flex-1 min-w-[200px]">
                    <label for="upcoming_query" class="block text-sm font-medium text-[#4B5563] mb-1">Mots-clés (thème, lieu, type)</label>
                    <input type="text" id="upcoming_query" name="upcoming_query" value="{{ upcomingSearchQuery|default('') }}" placeholder="Ex. autisme inclusion conférence, atelier sensoriel Paris" class="w-full px-4 py-2.5 rounded-lg border border-[#E5E0D8] bg-white text-[#4B5563] placeholder-[#9CA3AF] focus:outline focus:ring-2 focus:ring-[#A7C7E7]">
                </div>
                <div class="min-w-[160px]">
                    <label for="upcoming_period" class="block text-sm font-medium text-[#4B5563] mb-1">Période</label>
                    <select id="upcoming_period" name="upcoming_period" class="w-full px-4 py-2.5 rounded-lg border border-[#E5E0D8] bg-white text-[#4B5563] focus:outline focus:ring-2 focus:ring-[#A7C7E7]">
                        {% for label, value in periods|default([]) %}
                            <option value="{{ label }}" {{ (upcomingSearchPeriod|default('2025')) == label ? 'selected' : '' }}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="px-5 py-2.5 rounded-lg bg-violet-600 text-white font-medium hover:bg-violet-700 focus:outline focus:ring-2 focus:ring-violet-500">
                    Rechercher dans le monde
                </button>
            </form>
            {% if not googleSearchConfigured|default(false) %}
                <p class="text-xs text-[#6B7280] mt-3">Sans clé Google, utilisez le bouton « Ouvrir sur Google » dans les résultats après avoir lancé une recherche. Aucune carte bancaire nécessaire.</p>
            {% endif %}
        </div>
        {% if upcomingSearchPerformed|default(false) or (upcomingEventsResults is defined and upcomingEventsResults is not null) %}
            <div id="resultats-recherche-mondiale" class="p-6 border-t border-[#E5E0D8] bg-[#FAFAFA]/30">
                <h3 class="text-base font-medium text-[#4B5563] mb-3">Résultats de la recherche</h3>
                {% if upcomingEventsError|default(null) %}
                    {% set _search_query = upcomingSearchQuerySent|default('') != '' ? upcomingSearchQuerySent : 'upcoming events ' ~ (upcomingSearchQuery|default('')) ~ ' ' ~ (upcomingSearchPeriod|default('2025')) %}
                    <p class="text-sm text-[#6B7280] mb-3">La recherche intégrée (Google API) n’est pas configurée. Aucun résultat de secours n’a pu être récupéré pour cette requête.</p>
                    <p class="mb-2">Requête : <code class="px-1.5 py-0.5 rounded bg-[#E5E0D8]">{{ _search_query|e }}</code></p>
                    <a href="https://www.google.com/search?q={{ _search_query|url_encode }}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-violet-600 text-white font-medium hover:bg-violet-700 focus:outline focus:ring-2 focus:ring-violet-500 no-underline">
                        Ouvrir la recherche sur Google (nouvel onglet)
                    </a>
                {% endif %}
                {% if upcomingEventsResults is defined and upcomingEventsResults is not null %}
                    {% if upcomingEventsResults is empty and not upcomingEventsError %}
                        <p class="text-[#6B7280] text-sm mb-2">Aucun résultat pour « {{ upcomingSearchQuery|e }} » sur la période choisie.</p>
                        {% if upcomingSearchQuerySent|default('') %}
                            <p class="text-xs text-[#9CA3AF] mb-2">Requête envoyée à Google : <code class="px-1.5 py-0.5 rounded bg-[#E5E0D8]">{{ upcomingSearchQuerySent|e }}</code></p>
                            <p class="text-xs text-[#6B7280]">Conseil : essayez d’autres mots-clés (ex. « journée autisme 2025 », « colloque inclusion ») ou <a href="https://www.google.com/search?q={{ upcomingSearchQuerySent|url_encode }}" target="_blank" rel="noopener" class="text-violet-600 hover:underline">testez cette requête sur Google</a> pour voir si des pages existent.</p>
                        {% else %}
                            <p class="text-xs text-[#6B7280]">Essayez d’autres mots-clés ou une autre période.</p>
                        {% endif %}
                    {% elseif upcomingEventsResults is not empty %}
                        <p class="text-sm text-[#6B7280] mb-4">{{ upcomingEventsResults|length }} résultat(s) pour « {{ upcomingSearchQuery|e }} ».</p>
                        <div class="space-y-4">
                            {% for item in upcomingEventsResults %}
                                <div class="border border-[#E5E0D8] rounded-lg p-4 bg-white">
                                    <a href="{{ item.url|e('html_attr') }}" target="_blank" rel="noopener" class="font-medium text-[#4B5563] hover:text-violet-600 hover:underline block mb-1">{{ item.name }}</a>
                                    <p class="text-sm text-[#6B7280]">{{ item.snippet }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        {% endif %}
    </div>
    {% if upcomingSearchPerformed|default(false) %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var el = document.getElementById('resultats-recherche-mondiale');
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        </script>
    {% endif %}
</div>
{% endblock %}
