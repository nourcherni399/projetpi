{% extends 'layouts/admin.html.twig' %}

{% block title %}Événements - AutiCare Admin{% endblock %}

{% block admin_content %}
<div class="w-full max-w-[1600px]">
<h1 class="text-2xl font-semibold text-[#4B5563] mb-6">Gestion des événements</h1>
{% for message in app.flashes('success') %}
    <div class="mb-4 px-4 py-3 rounded-lg bg-emerald-50 border border-emerald-200 text-emerald-800">{{ message }}</div>
{% endfor %}
{% for message in app.flashes('error') %}
    <div class="mb-4 px-4 py-3 rounded-lg bg-red-50 border border-red-200 text-red-800">{{ message }}</div>
{% endfor %}

<div class="bg-white rounded-xl border border-[#E5E0D8] overflow-hidden">
    <div class="p-4 border-b border-[#E5E0D8] flex flex-wrap gap-4 justify-between">
    <div class="flex flex-wrap gap-4 items-end">
        <form method="get" action="{{ path('admin_evenement_index') }}" class="flex flex-wrap gap-4 items-end flex-1 min-w-0">
            <div class="flex-1 min-w-[280px]">
                <label for="q" class="block text-sm font-medium text-[#4B5563] mb-1">Recherche</label>
                <input type="search" id="q" name="q" value="{{ q|default('') }}" placeholder="Titre, lieu, thématique ou date" class="w-full px-4 py-2 rounded-lg border border-[#E5E0D8] bg-[#F5F1EB] text-[#4B5563] placeholder-[#9CA3AF] focus:outline focus:ring-2 focus:ring-[#A7C7E7]">
            </div>
            <div>
                <label for="sort" class="block text-sm font-medium text-[#4B5563] mb-1">Tri</label>
                <select id="sort" name="sort" class="px-4 py-2 rounded-lg border border-[#E5E0D8] bg-white text-[#4B5563] focus:outline focus:ring-2 focus:ring-[#A7C7E7] js-sort-submit">
                    <option value="date" {{ sortBy|default('date') == 'date' ? 'selected' : '' }}>Date</option>
                    <option value="titre" {{ sortBy|default('date') == 'titre' ? 'selected' : '' }}>Titre</option>
                    <option value="lieu" {{ sortBy|default('date') == 'lieu' ? 'selected' : '' }}>Lieu</option>
                    <option value="theme" {{ sortBy|default('date') == 'theme' ? 'selected' : '' }}>Thématique</option>
                </select>
            </div>
            <div>
                <label for="order" class="block text-sm font-medium text-[#4B5563] mb-1">Ordre</label>
                <select id="order" name="order" class="px-4 py-2 rounded-lg border border-[#E5E0D8] bg-white text-[#4B5563] focus:outline focus:ring-2 focus:ring-[#A7C7E7] js-sort-submit">
                    <option value="asc" {{ sortOrder|default('asc') == 'asc' ? 'selected' : '' }}>Croissant</option>
                    <option value="desc" {{ sortOrder|default('asc') == 'desc' ? 'selected' : '' }}>Décroissant</option>
                </select>
            </div>
            <button type="submit" class="px-4 py-2 rounded-lg bg-[#F5F1EB] border border-[#E5E0D8] text-[#4B5563] font-medium hover:bg-[#E5E0D8] focus:outline focus:ring-2 focus:ring-[#A7C7E7]">Filtrer</button>
        </form>
        <a href="{{ path('admin_evenement_new') }}" class="px-4 py-2 rounded-lg bg-[#A7C7E7] text-white font-medium hover:bg-[#B8D4ED] focus:outline focus:ring-2 focus:ring-[#A7C7E7] no-underline shrink-0">Nouvel élément</a>
    </div>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead class="bg-[#F5F1EB] border-b border-[#E5E0D8]">
                <tr>
                    <th class="px-6 py-4 font-medium text-[#4B5563]">Titre</th>
                    <th class="px-6 py-4 font-medium text-[#4B5563] text-center">Date</th>
                    <th class="px-6 py-4 font-medium text-[#4B5563] text-center">Lieu</th>
                    <th class="px-6 py-4 font-medium text-[#4B5563]">Thématique</th>
                    <th class="px-6 py-4 font-medium text-[#4B5563] text-center">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-[#E5E0D8]">
                {% for event in evenements %}
                <tr class="hover:bg-[#F5F1EB]/50">
                    <td class="px-6 py-4 text-[#4B5563]">{{ event.title }}</td>
                    <td class="px-6 py-4 text-[#6B7280] text-center">{{ event.dateEvent ? event.dateEvent|date('d/m/Y') : '—' }}</td>
                    <td class="px-6 py-4 text-[#6B7280] text-center">{{ event.lieu }}</td>
                    <td class="px-6 py-4 text-[#6B7280]">{{ event.thematique ? event.thematique.nomThematique : '—' }}</td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex gap-2 items-center justify-center">
                            <a href="{{ path('admin_evenement_show', { id: event.id }) }}" class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-green-50 text-green-600 hover:bg-green-100 focus:outline focus:ring-2 focus:ring-green-500" title="Voir">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </a>
                            <a href="{{ path('admin_evenement_edit', { id: event.id }) }}" class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 focus:outline focus:ring-2 focus:ring-blue-500" title="Modifier">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </a>
                            <form method="post" action="{{ path('admin_evenement_delete', { id: event.id }) }}" class="inline" onsubmit="return confirm('Supprimer cet événement ?');">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete_evenement_' ~ event.id) }}">
                                <button type="submit" class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 focus:outline focus:ring-2 focus:ring-red-500" title="Supprimer">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="px-6 py-8 text-center text-[#6B7280]">Aucun événement.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Visualisations avec graphiques (comme page Modules) -->
<div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white rounded-xl shadow-sm border border-[#E5E0D8] p-6">
        <h3 class="text-lg font-semibold text-[#4B5563] mb-4">Répartition des événements par période</h3>
        <div class="relative h-64 flex items-center justify-center">
            <canvas id="eventPeriodChart" width="300" height="300"></canvas>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-sm border border-[#E5E0D8] p-6">
        <h3 class="text-lg font-semibold text-[#4B5563] mb-4">Répartition des inscriptions</h3>
        <div class="relative h-64 flex items-center justify-center">
            <canvas id="inscriptionChart" width="300" height="300"></canvas>
        </div>
    </div>
</div>

<!-- Statistiques des événements -->
<div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <div class="bg-white rounded-xl shadow-sm border border-[#E5E0D8] p-6">
        <h3 class="text-lg font-semibold text-[#4B5563] mb-4">Événements par période</h3>
        <div class="space-y-3">
            <div class="flex items-center justify-between">
                <span class="text-sm text-[#6B7280]">À venir</span>
                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">{{ evenementsAvenir|default(0) }}</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-sm text-[#6B7280]">Passés</span>
                <span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs font-medium rounded-full">{{ evenementsPasses|default(0) }}</span>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-sm border border-[#E5E0D8] p-6">
        <h3 class="text-lg font-semibold text-[#4B5563] mb-4">Inscriptions par statut</h3>
        <div class="space-y-3">
            <div class="flex items-center justify-between">
                <span class="text-sm text-[#6B7280]">Acceptées</span>
                <span class="px-2 py-1 bg-teal-100 text-teal-800 text-xs font-medium rounded-full">{{ inscriptionsAcceptees|default(0) }}</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-sm text-[#6B7280]">En attente</span>
                <span class="px-2 py-1 bg-amber-100 text-amber-800 text-xs font-medium rounded-full">{{ inscriptionsEnAttente|default(0) }}</span>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-sm border border-[#E5E0D8] p-6">
        <h3 class="text-lg font-semibold text-[#4B5563] mb-4">Statistiques générales</h3>
        <div class="grid grid-cols-2 gap-4">
            <div class="text-center">
                <div class="text-2xl font-bold text-[#4B5563]">{{ totalEvenements|default(0) }}</div>
                <div class="text-sm text-[#6B7280]">Total des événements</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600">{{ evenementsAvenir|default(0) }}</div>
                <div class="text-sm text-[#6B7280]">À venir</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-orange-600">{{ totalInscriptions|default(0) }}</div>
                <div class="text-sm text-[#6B7280]">Total inscriptions</div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function() {
    var searchInput = document.getElementById('q');
    var form = searchInput ? searchInput.closest('form') : null;
    if (form && searchInput) {
        function submitIfEmpty() {
            if (searchInput.value.trim() === '') form.submit();
        }
        searchInput.addEventListener('input', submitIfEmpty);
        searchInput.addEventListener('search', submitIfEmpty);
    }
    document.querySelectorAll('.js-sort-submit').forEach(function(el) {
        el.addEventListener('change', function() { this.closest('form').submit(); });
    });

    if (typeof Chart !== 'undefined') {
        var periodData = { 'À venir': {{ evenementsAvenir|default(0) }}, 'Passés': {{ evenementsPasses|default(0) }} };
        var periodCtx = document.getElementById('eventPeriodChart');
        if (periodCtx) {
            new Chart(periodCtx.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: Object.keys(periodData),
                    datasets: [{
                        data: Object.values(periodData),
                        backgroundColor: ['#10B981', '#9CA3AF'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 } } },
                        tooltip: { callbacks: { label: function(c) { return (c.label || '') + ': ' + (c.parsed || 0) + ' événement(s)'; } } }
                    }
                }
            });
        }
        var inscData = { 'Acceptées': {{ inscriptionsAcceptees|default(0) }}, 'En attente': {{ inscriptionsEnAttente|default(0) }} };
        var inscCtx = document.getElementById('inscriptionChart');
        if (inscCtx) {
            new Chart(inscCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(inscData),
                    datasets: [{
                        data: Object.values(inscData),
                        backgroundColor: ['#14B8A6', '#F59E0B'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 } } },
                        tooltip: { callbacks: { label: function(c) { return (c.label || '') + ': ' + (c.parsed || 0); } } }
                    }
                }
            });
        }
    }
})();
</script>
</div>
{% endblock %}