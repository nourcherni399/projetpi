{% extends 'layouts/user.html.twig' %}

{% block title %}Finaliser la commande - AutiCare{% endblock %}

{% block user_content %}
<section class="text-center mb-10">
    <h1 class="text-3xl font-bold text-[#4B5563] mb-3">Finaliser votre commande</h1>
    <p class="text-[#6B7280]">Vos informations liées au compte sont pré-remplies. Complétez l'adresse et le mode de paiement.</p>
</section>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2">
        {{ form_start(form, { attr: { class: 'space-y-6', novalidate: 'novalidate' } }) }}
            <div class="bg-white rounded-xl shadow-sm border border-[#E5E0D8] p-6">
                <h2 class="text-xl font-semibold text-[#4B5563] mb-4">Informations personnelles</h2>
                <p class="text-sm text-[#6B7280] mb-4">Ces champs sont renseignés depuis votre compte et ne peuvent pas être modifiés ici.</p>
                <div class="space-y-4">
                    {{ form_row(form.nom) }}
                    {{ form_row(form.email) }}
                    {{ form_row(form.telephone) }}
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-[#E5E0D8] p-6">
                <h2 class="text-xl font-semibold text-[#4B5563] mb-4">Adresse de livraison</h2>
                <div class="space-y-4">
                    {{ form_row(form.adresse) }}
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {{ form_row(form.codePostal) }}
                        {{ form_row(form.ville) }}
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-[#E5E0D8] p-6">
                <h2 class="text-xl font-semibold text-[#4B5563] mb-4">Mode de Paiement *</h2>
                <div class="space-y-4" id="mode-payment-choices">
                    {% for choice in form.modePayment.vars.choices %}
                    <label class="flex items-start gap-3 p-4 rounded-xl border-2 cursor-pointer transition {{ form.modePayment.vars.value == choice.value ? 'border-[#A7C7E7] bg-[#A7C7E7]/5' : 'border-[#E5E0D8] hover:border-[#E5E0D8] hover:bg-[#F9FAFB]' }}">
                        <input type="radio" name="{{ form.modePayment.vars.full_name }}" value="{{ choice.value }}" {{ form.modePayment.vars.value == choice.value ? 'checked' : '' }} class="mt-1 w-4 h-4 text-[#A7C7E7] focus:ring-[#A7C7E7]">
                        <div>
                            <span class="font-medium text-[#4B5563]">{{ choice.label }}</span>
                            {% if choice.value == 'a_la_livraison' %}
                            <p class="text-sm text-[#6B7280] mt-1">Payez à la réception de votre commande</p>
                            {% else %}
                            <p class="text-sm text-[#6B7280] mt-1">Visa, Mastercard, American Express</p>
                            {% endif %}
                        </div>
                    </label>
                    {% endfor %}
                </div>
                {{ form_errors(form.modePayment) }}
                <div id="card-fields" class="mt-6 space-y-4 hidden">
                    <div>{{ form_row(form.numeroCarte, { label_attr: { class: 'block text-[#4B5563] font-medium mb-1' }, attr: { class: 'w-full px-4 py-2.5 rounded-lg border border-[#E5E0D8] focus:ring-2 focus:ring-[#A7C7E7] focus:border-[#A7C7E7]' } }) }}</div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>{{ form_row(form.dateExpiration, { label_attr: { class: 'block text-[#4B5563] font-medium mb-1' }, attr: { class: 'w-full px-4 py-2.5 rounded-lg border border-[#E5E0D8] focus:ring-2 focus:ring-[#A7C7E7] focus:border-[#A7C7E7]' } }) }}</div>
                        <div>{{ form_row(form.cvv, { label_attr: { class: 'block text-[#4B5563] font-medium mb-1' }, attr: { class: 'w-full px-4 py-2.5 rounded-lg border border-[#E5E0D8] focus:ring-2 focus:ring-[#A7C7E7] focus:border-[#A7C7E7]' } }) }}</div>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap gap-4 mt-6">
                <button type="submit" class="px-6 py-3 bg-[#3B82F6] text-white rounded-lg font-semibold hover:bg-[#2563EB] transition">
                    Confirmer la Commande
                </button>
                <a href="{{ path('cart_index') }}" class="px-6 py-3 bg-white border border-[#E5E0D8] text-[#4B5563] rounded-lg font-semibold hover:bg-[#F5F1EB] transition inline-block">
                    Retour au Panier
                </a>
            </div>
        {{ form_end(form) }}
    </div>

    <div>
        <div class="bg-white rounded-xl shadow-sm border border-[#E5E0D8] p-6 sticky top-20">
            <h3 class="text-lg font-semibold text-[#4B5563] mb-4">Résumé de la commande</h3>
            <div class="space-y-3 mb-6 pb-6 border-b border-[#E5E0D8]">
                {% for item in cart.items %}
                <div class="flex justify-between text-sm text-[#6B7280]">
                    <span>{{ item.produit.nom }} x {{ item.quantite }}</span>
                    <span>{{ item.totalPrice|number_format(2, ',', ' ') }} د.ت</span>
                </div>
                {% endfor %}
                <div class="flex justify-between text-[#6B7280] text-sm pt-2">
                    <span>Nombre d'articles :</span>
                    <span>{{ totalItems }}</span>
                </div>
            </div>
            <div class="flex justify-between text-lg font-bold text-[#4B5563] mb-6">
                <span>Total :</span>
                <span class="text-[#A7C7E7]">{{ totalPrice|number_format(2, ',', ' ') }} د.ت</span>
            </div>
            <div class="bg-[#F5F1EB] rounded-lg p-4 text-sm text-[#6B7280]">
                <p><strong>Livraison gratuite</strong> partout en Tunisie.</p>
                <p class="mt-2">Votre commande sera livrée dans 2-3 jours ouvrables.</p>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    var cardFields = document.getElementById('card-fields');
    var radios = document.querySelectorAll('input[name="{{ form.modePayment.vars.full_name|e('js') }}"]');
    function toggleCardFields() {
        var isCard = false;
        radios.forEach(function(r) { if (r.checked && r.value === 'carte_bancaire') isCard = true; });
        if (cardFields) cardFields.classList.toggle('hidden', !isCard);
    }
    radios.forEach(function(r) { r.addEventListener('change', toggleCardFields); });
    toggleCardFields();
})();
</script>
{% endblock %}
