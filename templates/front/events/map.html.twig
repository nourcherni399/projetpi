{% extends 'layouts/user.html.twig' %}

{% block title %}Carte des événements - AutiCare{% endblock %}

{% block user_content %}
<div class="mb-6 flex flex-wrap items-center gap-4">
    <a href="{{ path('user_events') }}" class="inline-flex items-center gap-2 text-[#6B7280] hover:text-[#A7C7E7] focus:outline focus:ring-2 focus:ring-[#A7C7E7] rounded">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
        Retour aux événements
    </a>
    <h1 class="text-2xl font-bold text-[#4B5563]">Carte des événements</h1>
</div>

{% if eventsForMap is empty %}
<div class="rounded-xl border border-[#E5E0D8] bg-[#F9FAFB] p-8 text-center text-[#6B7280]">
    <svg class="w-16 h-16 mx-auto text-[#E5E0D8] mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" /></svg>
    <p class="font-medium text-[#4B5563]">Aucun événement à venir avec localisation sur la carte.</p>
    <p class="text-sm mt-1">Les événements avec coordonnées GPS (ou lien Google Maps avec adresse) apparaîtront ici.</p>
    <a href="{{ path('user_events') }}" class="inline-flex items-center gap-2 mt-4 px-4 py-2 rounded-lg bg-[#A7C7E7] text-white font-medium hover:bg-[#B8D4ED]">Voir la liste des événements</a>
</div>
{% else %}
<div class="rounded-xl border border-[#E5E0D8] overflow-hidden bg-white shadow-sm">
    <div id="map" class="w-full min-h-[480px] bg-[#E5E0D8]"></div>
    <div class="p-3 border-t border-[#E5E0D8] bg-[#F9FAFB] text-sm text-[#6B7280]">
        {{ eventsForMap|length }} événement(s) à venir. Carte OpenStreetMap · Cliquez sur un marqueur pour le détail.
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(function() {
    var events = {{ eventsForMap|json_encode|raw }};
    if (events.length === 0) return;

    var mapEl = document.getElementById('map');
    if (!mapEl) return;

    var leafletBase = 'https://unpkg.com/leaflet@1.9.4/dist/images';
    L.Icon.Default.mergeOptions({
        iconUrl: leafletBase + '/marker-icon.png',
        iconRetinaUrl: leafletBase + '/marker-icon-2x.png',
        shadowUrl: leafletBase + '/marker-shadow.png',
    });

    var center = events.length === 1
        ? [events[0].lat, events[0].lng]
        : [36.8065, 10.1815];
    var zoom = events.length === 1 ? 14 : 10;

    var map = L.map('map').setView(center, zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19,
    }).addTo(map);

    var bounds = null;
    function escapeHtml(str) {
        if (!str) return '';
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }
    function escapeAttr(str) {
        if (!str) return '';
        return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    events.forEach(function(ev) {
        var marker = L.marker([ev.lat, ev.lng]).addTo(map);
        var content = '<div class="p-2 min-w-[200px] max-w-[320px]">' +
            '<p class="font-semibold text-[#4B5563] text-sm">' + escapeHtml(ev.title) + '</p>' +
            (ev.lieu ? '<p class="text-[#6B7280] text-xs mt-1">' + escapeHtml(ev.lieu) + '</p>' : '') +
            (ev.date ? '<p class="text-[#9CA3AF] text-xs mt-0.5">' + escapeHtml(ev.date) + '</p>' : '') +
            '<a href="' + escapeAttr(ev.url) + '" class="inline-block mt-2 text-sm font-medium text-[#A7C7E7] hover:underline">Voir l\'événement →</a>' +
            '</div>';
        marker.bindPopup(content);
        if (!bounds) bounds = L.latLngBounds([ev.lat, ev.lng], [ev.lat, ev.lng]);
        else bounds.extend([ev.lat, ev.lng]);
    });

    if (events.length > 1 && bounds) {
        map.fitBounds(bounds, { padding: [48, 48] });
    }
})();
</script>
{% endif %}
{% endblock %}
