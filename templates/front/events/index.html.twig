{% extends 'layouts/user.html.twig' %}

{% block title %}Événements & Ateliers - AutiCare{% endblock %}

{% block user_content %}
<section class="text-center mb-8">
    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-[#95d7b5]/30 text-[#059669] mb-4">
        <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg>
    </div>
    <h1 class="text-3xl font-bold text-[#4B5563] mb-3">Événements & Ateliers</h1>
    <p class="text-[#6B7280] max-w-2xl mx-auto">Découvrez nos ateliers et rencontres par thématique.</p>
</section>

<form method="get" action="{{ path('user_events') }}" class="mb-8 p-5 bg-white rounded-xl border border-[#E5E0D8] shadow-sm">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
        <div>
            <label for="filter_date_from" class="block text-sm font-medium text-[#4B5563] mb-1">Date début</label>
            <input type="date" id="filter_date_from" name="date_from" value="{{ filter_date_from|default('') }}"
                class="w-full rounded-lg border border-[#E5E0D8] px-3 py-2 text-[#4B5563] focus:ring-2 focus:ring-[#A7C7E7] focus:border-[#A7C7E7]">
        </div>
        <div>
            <label for="filter_date_to" class="block text-sm font-medium text-[#4B5563] mb-1">Date fin</label>
            <input type="date" id="filter_date_to" name="date_to" value="{{ filter_date_to|default('') }}"
                class="w-full rounded-lg border border-[#E5E0D8] px-3 py-2 text-[#4B5563] focus:ring-2 focus:ring-[#A7C7E7] focus:border-[#A7C7E7]">
        </div>
        <div>
            <label for="filter_lieu" class="block text-sm font-medium text-[#4B5563] mb-1">Lieu</label>
            <input type="text" id="filter_lieu" name="lieu" value="{{ filter_lieu|default('') }}" placeholder="Ex. Salle d'art"
                class="w-full rounded-lg border border-[#E5E0D8] px-3 py-2 text-[#4B5563] focus:ring-2 focus:ring-[#A7C7E7] focus:border-[#A7C7E7]">
        </div>
        <div>
            <label for="filter_thematique" class="block text-sm font-medium text-[#4B5563] mb-1">Thématique</label>
            <select id="filter_thematique" name="thematique" class="w-full rounded-lg border border-[#E5E0D8] px-3 py-2 text-[#4B5563] focus:ring-2 focus:ring-[#A7C7E7] focus:border-[#A7C7E7]">
                <option value="">Toutes</option>
                {% for t in thematiques|default([]) %}
                <option value="{{ t.id }}" {{ (filter_thematique|default(0)) == t.id ? 'selected' : '' }}>{{ t.nomThematique }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex gap-2">
            <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-[#059669] text-white font-medium hover:bg-[#047857] focus:outline focus:ring-2 focus:ring-[#059669]">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                Rechercher
            </button>
            <a href="{{ path('user_events') }}" class="inline-flex items-center px-4 py-2 rounded-lg border border-[#E5E0D8] text-[#4B5563] font-medium hover:bg-[#F5F1EB] focus:outline focus:ring-2 focus:ring-[#A7C7E7]">Réinitialiser</a>
        </div>
    </div>
</form>

<div class="flex flex-wrap items-center justify-between gap-4 mb-4">
    <span class="text-sm font-medium text-[#4B5563]">Affichage :</span>
    <div class="flex rounded-lg border border-[#E5E0D8] p-1 bg-[#F9FAFB]" role="group" aria-label="Mode d’affichage">
        <button type="button" id="view-grid-btn" class="events-view-btn rounded-md px-3 py-2 text-sm font-medium transition-colors bg-[#059669] text-white" aria-pressed="true" title="Grille">
            <span class="inline-flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
                Grille
            </span>
        </button>
        <button type="button" id="view-list-btn" class="events-view-btn rounded-md px-3 py-2 text-sm font-medium transition-colors text-[#6B7280] hover:bg-[#E5E0D8] hover:text-[#4B5563]" aria-pressed="false" title="Liste">
            <span class="inline-flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                Liste
            </span>
        </button>
    </div>
</div>

<div id="thematiques-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" data-view="grid">
    {% for item in grouped %}
    {% set thematique = item.thematique %}
    {% set evenements = item.evenements %}
    <div class="events-card bg-white rounded-xl border border-[#E5E0D8] overflow-hidden flex flex-col shadow-sm hover:shadow-md transition-shadow {{ thematique.couleur ? 'border-l-4' : '' }}" {% if thematique.couleur %}style="border-left-color: {{ thematique.couleur }};"{% endif %}>
        <div class="events-card-media flex-shrink-0">
        {% if thematique.image %}
        {% set imgUrl = thematique.image starts with 'http' ? thematique.image : asset(thematique.image) %}
        <div class="aspect-[21/9] max-h-40 bg-[#E5E0D8] overflow-hidden">
            <img src="{{ imgUrl }}" alt="{{ thematique.nomThematique }}" class="w-full h-full object-cover" loading="lazy">
        </div>
        {% endif %}
        </div>
        <div class="events-card-body flex flex-col flex-1 min-w-0">
        <div class="p-5 border-b border-[#E5E0D8]">
            {% if thematique.couleur and not thematique.image %}
            <span class="inline-block w-10 h-10 rounded-lg border border-[#E5E0D8] mb-3" style="background-color: {{ thematique.couleur }};" title="Couleur"></span>
            {% endif %}
            <h2 class="text-lg font-semibold text-[#4B5563] mb-1">{{ thematique.nomThematique }}</h2>
            {% if thematique.sousTitre %}
            <p class="text-[#6B7280] text-sm mb-2">{{ thematique.sousTitre }}</p>
            {% elseif thematique.publicCible %}
            <p class="text-[#6B7280] text-sm mb-2">{{ thematique.publicCible.value }}</p>
            {% endif %}
            <p class="text-[#A7C7E7] font-medium text-sm">{{ evenements|length }} événement{{ evenements|length != 1 ? 's' : '' }}</p>
        </div>
        <div class="p-4 flex-1 space-y-3">
            {% for event in evenements %}
            <a href="{{ path('user_event_show', { id: event.id }) }}" class="block rounded-lg border border-[#E5E0D8] p-3 hover:bg-[#F5F1EB] hover:border-[#A7C7E7] transition-colors focus:outline focus:ring-2 focus:ring-[#A7C7E7]">
                <h3 class="font-semibold text-[#4B5563] text-sm mb-1">{{ event.title }}</h3>
                <p class="text-[#6B7280] text-xs">
                    {{ event.dateEvent ? event.dateEvent|date('d/m/Y') : '—' }}
                    {{ event.heureDebut ? event.heureDebut|date('H:i') : '' }}
                    · {{ event.lieu }}
                </p>
                <span class="inline-flex items-center gap-1 mt-2 text-[#A7C7E7] text-xs font-medium">En savoir plus →</span>
            </a>
            {% else %}
            <p class="text-[#6B7280] text-sm py-2">Aucun événement pour le moment.</p>
            {% endfor %}
        </div>
        </div>
    </div>
    {% endfor %}

    {% if sansThematique|length > 0 %}
    <div class="bg-white rounded-xl border border-[#E5E0D8] overflow-hidden flex flex-col md:col-span-2 lg:col-span-3">
        <div class="p-5 border-b border-[#E5E0D8]">
            <h2 class="text-lg font-semibold text-[#4B5563]">Autres événements</h2>
            <p class="text-[#A7C7E7] font-medium text-sm">{{ sansThematique|length }} événement{{ sansThematique|length != 1 ? 's' : '' }}</p>
        </div>
        <div class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            {% for event in sansThematique %}
            <a href="{{ path('user_event_show', { id: event.id }) }}" class="block rounded-lg border border-[#E5E0D8] p-3 hover:bg-[#F5F1EB] hover:border-[#A7C7E7] transition-colors focus:outline focus:ring-2 focus:ring-[#A7C7E7]">
                <h3 class="font-semibold text-[#4B5563] text-sm mb-1">{{ event.title }}</h3>
                <p class="text-[#6B7280] text-xs">
                    {{ event.dateEvent ? event.dateEvent|date('d/m/Y') : '—' }}
                    {{ event.heureDebut ? event.heureDebut|date('H:i') : '' }}
                    · {{ event.lieu }}
                </p>
                <span class="inline-flex items-center gap-1 mt-2 text-[#A7C7E7] text-xs font-medium">En savoir plus →</span>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

{% if grouped is empty and (sansThematique|default([])) is empty %}
<p class="text-center text-[#6B7280] py-12">Aucun événement à venir pour le moment.</p>
{% endif %}

<style>
#thematiques-container[data-view="list"] {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}
#thematiques-container[data-view="list"] .events-card {
    display: flex;
    flex-direction: row;
    max-width: 100%;
}
#thematiques-container[data-view="list"] .events-card-media {
    width: 14rem;
    min-width: 14rem;
    flex-shrink: 0;
}
#thematiques-container[data-view="list"] .events-card-media .aspect-[21\/9] {
    max-height: none;
    aspect-ratio: 21/9;
    height: 100%;
    min-height: 10rem;
}
#thematiques-container[data-view="list"] .events-card-body {
    display: flex;
    flex-direction: column;
    min-width: 0;
}
</style>

<script>
(function() {
    var container = document.getElementById('thematiques-container');
    var gridBtn = document.getElementById('view-grid-btn');
    var listBtn = document.getElementById('view-list-btn');
    if (!container || !gridBtn || !listBtn) return;
    var key = 'eventsView';
    function setView(view) {
        container.setAttribute('data-view', view);
        if (view === 'grid') {
            gridBtn.classList.add('bg-[#059669]', 'text-white');
            gridBtn.classList.remove('text-[#6B7280]');
            gridBtn.setAttribute('aria-pressed', 'true');
            listBtn.classList.remove('bg-[#059669]', 'text-white');
            listBtn.classList.add('text-[#6B7280]');
            listBtn.setAttribute('aria-pressed', 'false');
        } else {
            listBtn.classList.add('bg-[#059669]', 'text-white');
            listBtn.classList.remove('text-[#6B7280]');
            listBtn.setAttribute('aria-pressed', 'true');
            gridBtn.classList.remove('bg-[#059669]', 'text-white');
            gridBtn.classList.add('text-[#6B7280]');
            gridBtn.setAttribute('aria-pressed', 'false');
        }
        try { localStorage.setItem(key, view); } catch (e) {}
    }
    gridBtn.addEventListener('click', function() { setView('grid'); });
    listBtn.addEventListener('click', function() { setView('list'); });
    try {
        var saved = localStorage.getItem(key);
        if (saved === 'list') setView('list');
    } catch (e) {}
})();
</script>
{% endblock %}
