{% extends 'layouts/user.html.twig' %}

{% block title %}{{ module.titre }} - Blog AutiCare{% endblock %}

{% block user_content %}
<article class="max-w-7xl mx-auto">
    <div class="mb-6">
        <a href="{{ path('user_blog') }}" class="inline-flex items-center gap-2 text-[#6B7280] hover:text-[#A7C7E7] focus:outline focus:ring-2 focus:ring-[#A7C7E7] rounded-lg text-sm font-medium">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
            Retour au blog
        </a>
    </div>

    {% for message in app.flashes('success') %}
        <div class="mb-6 px-4 py-3 rounded-lg bg-emerald-50 border border-emerald-200 text-emerald-800">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="mb-6 px-4 py-3 rounded-lg bg-red-50 border border-red-200 text-red-800">{{ message }}</div>
    {% endfor %}

    <div class="flex flex-col lg:flex-row gap-8 items-start">
    <!-- Colonne gauche : Contenu du module -->
    <div class="w-full lg:w-2/5 lg:min-w-0 lg:sticky lg:top-8 flex-shrink-0">
    <div class="bg-white rounded-xl border border-[#E5E0D8] p-6 md:p-8">
        <header class="mb-8">
            <!-- Image en petit avant le titre -->
            {% if module.image %}
                <div class="mb-4">
                    <img src="{{ asset(module.image) }}" alt="{{ module.titre }}" class="w-12 h-12 object-cover rounded-lg">
                </div>
            {% endif %}
            
            <div class="flex items-center gap-4 mb-3">
                <span class="inline-block px-3 py-1 rounded-lg bg-[#A7C7E7]/30 text-[#4B5563] text-sm font-medium">{{ module.niveau|capitalize }}</span>
                <h1 class="text-3xl font-bold text-[#4B5563] flex items-center gap-3">
                    {{ module.titre }}
                    <a href="{{ path('user_blog_module_download', { id: module.id }) }}"
                       class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 focus:outline focus:ring-2 focus:ring-blue-500"
                       title="Télécharger le module">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M8 12l4 4m0 0l4-4m-4 4V4" />
                        </svg>
                    </a>
                </h1>
            </div>
            {% if module.dateCreation %}
            <p class="text-[#6B7280] text-sm">Publié le {{ module.dateCreation|date('d/m/Y') }}</p>
            {% endif %}
        </header>

        {% if module.description %}
        <p class="text-lg text-[#6B7280] mb-6 whitespace-normal break-words">{{ module.description }}</p>
        {% endif %}

        <div class="prose prose-[#4B5563] max-w-none mb-10 break-words">
            {% if module.contenu %}
            <div class="text-[#4B5563] whitespace-pre-wrap break-words">{{ module.contenu }}</div>
            {% else %}
            <p class="text-[#6B7280]">Aucun contenu disponible.</p>
            {% endif %}
        </div>

        <div class="pt-8 border-t border-[#E5E0D8]">
            {% if app.user %}
                <a href="{{ path('user_blog_ecrire', { id: module.id }) }}" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-[#A7C7E7] text-white font-medium hover:bg-[#B8D4ED] focus:outline focus:ring-2 focus:ring-[#A7C7E7]">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.897L8 18l.8-2.685a4.5 4.5 0 011.898-1.897l8.932-8.931zm0 0L19.5 7.125" /></svg>
                    Écrire un article
                </a>
            {% else %}
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-blue-700 mb-2">Pour écrire un article, veuillez vous <a href="{{ path('app_login') }}" class="text-blue-600 hover:text-blue-800 underline">connecter</a>.</p>
                </div>
            {% endif %}
        </div>
    </div>
    </div>

    <!-- Colonne droite : Articles du module -->
    <div class="w-full lg:flex-1 lg:min-w-0">
    {# Articles publiés #}
    {% set allBlogs = module.blogs %}
    {% set articles = allBlogs|filter(blog => blog.isPublished) %}

    {# Brouillons de l'utilisateur connecté #}
    {% set drafts = [] %}
    {% if app.user %}
        {% set drafts = allBlogs|filter(blog => (not blog.isPublished) and blog.user and blog.user.id == app.user.id) %}
    {% endif %}

    {# Filtre de recherche sur le titre #}
    {% if searchTerm is defined and searchTerm is not empty %}
        {% set articles = articles|filter(blog => blog.titre is not empty and (searchTerm|lower in blog.titre|lower)) %}
        {% if app.user %}
            {% set drafts = drafts|filter(blog => blog.titre is not empty and (searchTerm|lower in blog.titre|lower)) %}
        {% endif %}
    {% endif %}

    {% set hasResults = (articles|length > 0) or (app.user and drafts|length > 0) %}

    {% if hasResults %}
        <div>
            <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-4">
                <h2 class="text-xl font-semibold text-[#4B5563]">Articles publiés pour ce module</h2>
                <form method="get" action="{{ path('user_blog_module', { id: module.id }) }}" class="w-full md:w-80">
                    <label for="search-article" class="block text-sm font-medium text-[#6B7280] mb-1"></label>
                    <div class="relative">
                        <input
                            type="text"
                            id="search-article"
                            name="q"
                            value="{{ searchTerm ?? '' }}"
                            placeholder="Tapez un titre d'article..."
                            class="w-full rounded-lg border border-[#E5E0D8] px-3 py-2 pl-9 text-sm text-[#111827] placeholder-[#9CA3AF] focus:outline-none focus:ring-2 focus:ring-[#A7C7E7]"
                        >
                        <span class="absolute inset-y-0 left-2 flex items-center pointer-events-none text-[#9CA3AF]">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M11 18a7 7 0 100-14 7 7 0 000 14z" />
                            </svg>
                        </span>
                    </div>
                </form>
            </div>

            {# Liste des articles publiés #}
            {% if articles|length > 0 %}
            <div class="space-y-4">
                {% for article in articles|sort((a, b) => b.dateCreation <=> a.dateCreation) %}
                    <div class="bg-white rounded-xl border border-[#E5E0D8] p-6 hover:shadow-md transition-shadow relative">
                        <!-- Icônes d'action fixes dans le coin supérieur droit -->
                        <div class="absolute top-4 right-4 flex gap-2">
                            <a href="{{ path('user_blog_article_download', {'id': article.id}) }}"
                               class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-green-50 text-green-600 hover:bg-green-100 focus:outline focus:ring-2 focus:ring-green-500"
                               title="Télécharger l'article">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M8 12l4 4m0 0l4-4m-4 4V4" />
                                </svg>
                            </a>
                            {% if app.user and (article.user and article.user.id == app.user.id or is_granted('ROLE_ADMIN')) %}
                                <a href="{{ path('user_blog_edit_article', {'id': article.id, 'moduleId': module.id}) }}" class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 focus:outline focus:ring-2 focus:ring-blue-500" title="Modifier l'article">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </a>
                                <form method="post" action="{{ path('user_blog_delete_article', {'id': article.id, 'moduleId': module.id}) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cet article ?');" class="inline">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ article.id) }}">
                                    <button type="submit" class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 focus:outline focus:ring-2 focus:ring-red-500" title="Supprimer l'article">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </form>
                            {% endif %}
                        </div>

                        <div class="pr-16">
                            <div class="flex items-start gap-3 mb-3">
                                <!-- Image de l'article en petit -->
                                {% if article.image %}
                                    <div class="flex-shrink-0">
                                        <img src="{{ asset(article.image) }}" alt="{{ article.titre }}" class="w-12 h-12 object-cover rounded-lg">
                                    </div>
                                {% endif %}
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-[#4B5563] mb-2">{{ article.titre }}</h3>
                                    <div class="flex items-center gap-4 text-sm text-[#6B7280] mb-3">
                                        <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full
                                            {% if article.type == 'recommandation' %}bg-blue-100 text-blue-800
                                            {% elseif article.type == 'plainte' %}bg-red-100 text-red-800
                                            {% elseif article.type == 'question' %}bg-yellow-100 text-yellow-800
                                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                                            {{ article.type|capitalize }}
                                        </span>
                                        {% if article.isUrgent %}
                                            <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Urgent</span>
                                        {% endif %}
                                        <span>Par {{ article.user ? article.user.email : 'Anonyme' }}</span>
                                        <span>Le {{ article.dateCreation|date('d/m/Y à H:i') }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="prose prose-[#4B5563] max-w-none">
                            <p class="text-[#4B5563] break-words whitespace-normal">{{ article.contenu|length > 200 ? (article.contenu|slice(0, 200) ~ '...') : article.contenu }}</p>
                            
                            <!-- Section de commentaire - Ajout ici -->
                            {# Les commentaires sont gérés sur la page de l'article (#user_blog_show_article),
                               ici on affiche seulement un extrait de l'article. #}
                            <div class="mt-3 flex justify-end">
                                <a href="{{ path('user_blog_show_article', {'id': article.id}) }}" class="inline-flex items-center gap-2 text-[#A7C7E7] hover:text-[#B8D4ED] font-medium text-sm focus:outline focus:ring-2 focus:ring-[#A7C7E7] rounded-lg">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                                    </svg>
                                    Lire la suite
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% endif %}

            {# Section des brouillons de l'utilisateur connecté #}
            {% if app.user and drafts|length > 0 %}
                <div class="mt-8 pt-6 border-t border-[#E5E0D8]">
                    <h3 class="text-lg font-semibold text-[#4B5563] mb-4">Vos brouillons</h3>
                    <div class="space-y-4">
                        {% for article in drafts|sort((a, b) => b.dateCreation <=> a.dateCreation) %}
                            <div class="bg-white rounded-xl border border-dashed border-[#E5E0D8] p-6 hover:shadow-sm transition-shadow relative">
                                <div class="absolute top-4 right-4 flex gap-2">
                                    <span class="inline-flex items-center justify-center px-2 py-1 rounded-full bg-yellow-50 text-yellow-700 text-xs font-medium">
                                        Brouillon
                                    </span>
                                    <a href="{{ path('user_blog_edit_article', {'id': article.id, 'moduleId': module.id}) }}" class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 focus:outline focus:ring-2 focus:ring-blue-500" title="Modifier le brouillon">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </a>
                                    <form method="post" action="{{ path('user_blog_delete_article', {'id': article.id, 'moduleId': module.id}) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce brouillon ?');" class="inline">
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ article.id) }}">
                                        <button type="submit" class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 focus:outline focus:ring-2 focus:ring-red-500" title="Supprimer le brouillon">
                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </form>
                                </div>

                                <div class="pr-16">
                                    <div class="flex items-start gap-3 mb-3">
                                        {% if article.image %}
                                            <div class="flex-shrink-0">
                                                <img src="{{ asset(article.image) }}" alt="{{ article.titre }}" class="w-12 h-12 object-cover rounded-lg">
                                            </div>
                                        {% endif %}
                                        <div class="flex-1">
                                            <h4 class="text-lg font-semibold text-[#4B5563] mb-1">{{ article.titre }}</h4>
                                            <p class="text-sm text-[#6B7280] mb-2">Créé le {{ article.dateCreation|date('d/m/Y à H:i') }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="prose prose-[#4B5563] max-w-none">
                                    <p class="text-[#4B5563] break-words whitespace-normal">
                                        {{ article.contenu|length > 200 ? (article.contenu|slice(0, 200) ~ '...') : article.contenu }}
                                    </p>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    {% else %}
        <div class="bg-white rounded-xl border border-[#E5E0D8] p-8 text-center">
            {% if searchTerm is defined and searchTerm is not empty %}
                <p class="text-[#6B7280] mb-2">Aucun article (publié ou brouillon) ne correspond au titre « {{ searchTerm }} ».</p>
                <a href="{{ path('user_blog_module', { id: module.id }) }}" class="inline-flex items-center gap-2 text-sm text-[#A7C7E7] hover:text-[#B8D4ED] font-medium">
                    Réinitialiser la recherche
                </a>
            {% else %}
                <p class="text-[#6B7280] mb-4">Aucun article publié pour ce module.</p>
                <p class="text-sm text-[#9CA3AF]">Soyez le premier à écrire un article !</p>
            {% endif %}
        </div>
    {% endif %}
    </div>
    </div>
</article>
{% endblock %}
