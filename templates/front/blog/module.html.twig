{% extends 'layouts/user.html.twig' %}

{% block title %}{{ module.titre }} - Blog AutiCare{% endblock %}

{% block user_content %}
<article class="max-w-7xl mx-auto">
    <div class="mb-6">
        <a href="{{ path('user_blog') }}" class="inline-flex items-center gap-2 text-[#6B7280] hover:text-[#A7C7E7] focus:outline focus:ring-2 focus:ring-[#A7C7E7] rounded-lg text-sm font-medium">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
            Retour au blog
        </a>
    </div>

    {% for message in app.flashes('success') %}
        <div class="mb-6 px-4 py-3 rounded-lg bg-emerald-50 border border-emerald-200 text-emerald-800">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="mb-6 px-4 py-3 rounded-lg bg-red-50 border border-red-200 text-red-800">{{ message }}</div>
    {% endfor %}

    <div class="flex flex-col lg:flex-row gap-8 items-start">
    <!-- Colonne gauche : Contenu du module -->
    <div class="w-full lg:w-2/5 lg:min-w-0 lg:sticky lg:top-8 flex-shrink-0">
    <div class="bg-white rounded-xl border border-[#E5E0D8] p-6 md:p-8">
        <header class="mb-8">
            <div class="flex items-start justify-between gap-4 mb-3">
                <h1 class="text-3xl font-bold text-[#4B5563]">
                    {{ module.titre }}
                </h1>
                <span class="inline-block px-3 py-1 rounded-lg bg-[#A7C7E7]/30 text-[#4B5563] text-sm font-medium shrink-0">{{ module.niveau|capitalize }}</span>
            </div>
            {% if module.dateCreation %}
            <div class="inline-flex items-center gap-2">
                <p class="text-[#6B7280] text-sm">Publié le {{ module.dateCreation|date('d/m/Y') }}</p>
                <a href="{{ path('user_blog_module_download', { id: module.id }) }}"
                   class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 focus:outline focus:ring-2 focus:ring-blue-500 shrink-0"
                   title="Télécharger le module">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M8 12l4 4m0 0l4-4m-4 4V4" />
                    </svg>
                </a>
            </div>
            {% endif %}
        </header>

        {% if module.description %}
        <p class="text-lg text-[#6B7280] mb-6 whitespace-normal break-words">{{ module.description }}</p>
        {% endif %}

        {% if module.image %}
        <div class="mb-8">
            <img src="{{ asset(module.image) }}"
                 alt="{{ module.titre }}"
                 class="w-full max-w-[620px] aspect-[16/10] object-cover rounded-lg">
        </div>
        {% endif %}

        <div class="prose prose-[#4B5563] max-w-none mb-10 break-words">
            {% if module.contenu %}
            <div class="text-[#4B5563] whitespace-pre-wrap break-words">{{ module.contenu }}</div>
            {% else %}
            <p class="text-[#6B7280]">Aucun contenu disponible.</p>
            {% endif %}
        </div>

        {% set activeRessources = module.ressources|filter(ressource => ressource.isActive) %}
        {% set ressources = activeRessources|sort((a, b) => (a.ordre ?? 999999) <=> (b.ordre ?? 999999)) %}
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-[#4B5563] mb-4">Ressources du module</h2>
            {% if ressources|length > 0 %}
                <div class="space-y-4">
                    {% for ressource in ressources %}
                        {% set contenuUrl = (ressource.contenu starts with 'http://') or (ressource.contenu starts with 'https://') ? ressource.contenu : asset(ressource.contenu) %}
                        {% set isRemoteResource = (ressource.contenu starts with 'http://') or (ressource.contenu starts with 'https://') %}
                        <div class="rounded-lg border border-[#E5E0D8] p-4 bg-[#F9FAFB]">
                            <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
                                <div class="flex items-center gap-2 min-w-0">
                                    <h3 class="font-medium text-[#4B5563] truncate">{{ ressource.titre }}</h3>
                                    <a href="{{ contenuUrl }}"
                                       {% if isRemoteResource %}target="_blank" rel="noopener noreferrer"{% endif %}
                                       {% if not isRemoteResource %}download{% endif %}
                                       class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-[#E7EDF8] text-[#2563EB] hover:bg-[#DCE7FA] transition-colors shrink-0"
                                       title="Télécharger cette ressource"
                                       aria-label="Télécharger {{ ressource.titre }}">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v12m0 0l4-4m-4 4l-4-4m-5 8h18" />
                                        </svg>
                                    </a>
                                </div>
                                <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full
                                    {% if ressource.typeRessource == 'url' %}bg-blue-100 text-blue-800
                                    {% elseif ressource.typeRessource == 'video' %}bg-purple-100 text-purple-800
                                    {% else %}bg-green-100 text-green-800{% endif %}">
                                    {{ ressource.typeRessource|upper }}
                                </span>
                            </div>

                            {% if ressource.typeRessource == 'url' %}
                                <a href="{{ contenuUrl }}" target="_blank" rel="noopener noreferrer"
                                   class="inline-flex items-center gap-2 text-[#A7C7E7] hover:text-[#B8D4ED] font-medium text-sm">
                                    Ouvrir la ressource
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H18m0 0v4.5M18 6l-7.5 7.5M6 10.5V18h7.5" />
                                    </svg>
                                </a>
                            {% elseif ressource.typeRessource == 'video' %}
                                <video controls preload="metadata" class="w-full rounded-lg border border-[#E5E0D8] bg-black/5">
                                    <source src="{{ contenuUrl }}">
                                    Votre navigateur ne supporte pas la lecture vidéo.
                                </video>
                            {% elseif ressource.typeRessource == 'audio' %}
                                <audio controls preload="metadata" class="w-full">
                                    <source src="{{ contenuUrl }}">
                                    Votre navigateur ne supporte pas la lecture audio.
                                </audio>
                            {% else %}
                                <p class="text-sm text-[#6B7280]">Type de ressource non supporte.</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-[#6B7280]">Aucune ressource active pour ce module.</p>
            {% endif %}
        </div>

        {# Toast notification #}
        <div id="toast-notification" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden">
            <div class="px-4 py-2.5 rounded-lg bg-[#1F2937] text-white text-sm font-medium shadow-lg">
                <span id="toast-message"></span>
            </div>
        </div>

        <div id="module-share-modal" class="fixed inset-0 z-[60] hidden">
            <div id="module-share-backdrop" class="absolute inset-0 bg-black/45"></div>
            <div class="relative z-10 h-full w-full flex items-center justify-center p-4">
                <div class="w-full max-w-md rounded-2xl bg-white border border-[#E5E0D8] shadow-xl overflow-hidden">
                    <div class="flex items-center justify-between px-4 py-3 border-b border-[#E5E0D8]">
                        <h3 class="text-lg font-semibold text-[#4B5563]">Partager le module</h3>
                        <button type="button" id="close-module-share" class="px-2 py-1 rounded-lg text-[#6B7280] hover:bg-[#F3F4F6]">Fermer</button>
                    </div>

                    <div class="p-4 space-y-4">
                        <div class="rounded-xl border border-[#E5E0D8] bg-[#F9FAFB] p-3">
                            {% if module.image %}
                                <img src="{{ asset(module.image) }}" alt="{{ module.titre }}" class="w-full h-44 object-cover rounded-lg mb-3">
                            {% endif %}
                            <p class="font-semibold text-[#4B5563] line-clamp-2">{{ module.titre }}</p>
                            <p class="text-sm text-[#6B7280] line-clamp-2 mt-1">{{ module.description ?: 'Découvrez ce module sur AutiCare.' }}</p>
                        </div>

                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                            <button type="button" id="share-copy-link" class="px-3 py-2.5 rounded-xl bg-[#E0F2FE] text-[#0369A1] text-sm font-medium hover:bg-[#BAE6FD]">Copier lien</button>
                            <button type="button" id="share-native" class="px-3 py-2.5 rounded-xl bg-[#DCFCE7] text-[#15803D] text-sm font-medium hover:bg-[#BBF7D0]">Partager</button>
                            <button type="button" id="share-facebook" class="px-3 py-2.5 rounded-xl bg-[#DBEAFE] text-[#1D4ED8] text-sm font-medium hover:bg-[#BFDBFE]">Facebook</button>
                            <button type="button" id="share-messenger" class="px-3 py-2.5 rounded-xl bg-[#F3E8FF] text-[#7E22CE] text-sm font-medium hover:bg-[#E9D5FF]">Messenger</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="pt-3 border-t border-[#E5E0D8]">
            {% if app.user %}
                {% set hasFormErrors = articleForm is defined and articleForm and not articleForm.vars.valid and articleForm.vars.submitted %}
                {% set showArticleForm = articleForm is defined and articleForm and (articleForm.vars.submitted or hasFormErrors) %}

                <div class="py-0.5">
                    <div class="flex items-center justify-between w-full max-w-[300px] mx-auto -translate-x-1">
                        {# Coeur = enregistrer/retirer le module des favoris #}
                        <button type="button"
                                id="module-heart-btn"
                                class="inline-flex items-center justify-center w-10 h-10 rounded-full transition-colors {{ isModuleSaved is defined and isModuleSaved ? 'bg-[#BE185D] text-white' : 'bg-[#FCE7F3] text-[#BE185D]' }} hover:bg-[#FBCFE8]"
                                title="{{ isModuleSaved is defined and isModuleSaved ? 'Retirer des favoris' : 'Enregistrer le module' }}"
                                data-module-id="{{ module.id }}"
                                data-saved="{{ isModuleSaved is defined and isModuleSaved ? '1' : '0' }}"
                                data-toggle-url="{{ path('favoris_module_toggle', {id: module.id}) }}"
                                data-csrf="{{ csrf_token('toggle_module_favori_' ~ module.id) }}">
                            <svg class="w-5 h-5" fill="{{ isModuleSaved is defined and isModuleSaved ? 'currentColor' : 'none' }}" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                            </svg>
                        </button>

                        <button type="button"
                                id="toggle-article-form"
                                class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-[#DBEAFE] text-[#1D4ED8] hover:bg-[#BFDBFE] transition-colors"
                                aria-expanded="{{ showArticleForm ? 'true' : 'false' }}"
                                aria-controls="article-form-panel"
                                title="Ajouter un article">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14m-7-7h14" />
                            </svg>
                        </button>

                        <button type="button" id="repost-module" class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-[#E0F2FE] text-[#0369A1] hover:bg-[#BAE6FD] transition-colors" title="Copier le lien">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 1l4 4-4 4M3 11V9a4 4 0 014-4h14M7 23l-4-4 4-4M21 13v2a4 4 0 01-4 4H3" />
                            </svg>
                        </button>

                        <button type="button"
                                id="share-module"
                                class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-[#DCFCE7] text-[#15803D] hover:bg-[#BBF7D0] transition-colors"
                                title="Partager"
                                data-share-url="{{ url('user_blog_module', { id: module.id }) }}"
                                data-share-title="{{ module.titre }}"
                                data-share-text="Je vous partage ce module sur AutiCare.">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.1">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 8.25L19.5 12m0 0L15 15.75M19.5 12H9.75c-2.9 0-5.25 2.35-5.25 5.25" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="article-form-panel" class="mt-4 {{ showArticleForm ? '' : 'hidden' }}">
                    <div class="rounded-xl border border-[#E5E0D8] bg-[#F9FAFB] p-4 md:p-5">
                        <h3 class="text-lg font-semibold text-[#4B5563] mb-4">Nouvel article</h3>
                        {% if articleForm is defined and articleForm %}
                        {% form_theme articleForm 'form/form_div_layout.html.twig' %}
                            {{ form_start(articleForm, {'attr': {'class': 'space-y-4', 'novalidate': 'novalidate', 'id': 'article-form'}, 'label_attr': {'class': 'block text-[#4B5563] font-medium mb-1'}}) }}
                                {{ form_errors(articleForm) }}
                                <div>
                                    {{ form_label(articleForm.titre) }}
                                    {{ form_widget(articleForm.titre) }}
                                    {% if articleForm.titre.vars.errors|length > 0 %}
                                        <div class="mt-1 text-sm font-medium text-red-600" role="alert">{{ articleForm.titre.vars.errors|first.message }}</div>
                                    {% endif %}
                                </div>
                                <div>
                                    {{ form_label(articleForm.type) }}
                                    {{ form_widget(articleForm.type) }}
                                    {% if articleForm.type.vars.errors|length > 0 %}
                                        <div class="mt-1 text-sm font-medium text-red-600" role="alert">{{ articleForm.type.vars.errors|first.message }}</div>
                                    {% endif %}
                                </div>
                                <div>
                                    {{ form_label(articleForm.contenu) }}
                                    {{ form_widget(articleForm.contenu) }}
                                    {% if articleForm.contenu.vars.errors|length > 0 %}
                                        <div class="mt-1 text-sm font-medium text-red-600" role="alert">{{ articleForm.contenu.vars.errors|first.message }}</div>
                                    {% endif %}
                                </div>
                                <div>
                                    {{ form_label(articleForm.image) }}
                                    {{ form_widget(articleForm.image) }}
                                    {% if articleForm.image.vars.errors|length > 0 %}
                                        <div class="mt-1 text-sm font-medium text-red-600" role="alert">{{ articleForm.image.vars.errors|first.message }}</div>
                                    {% endif %}
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                    <div class="flex items-center gap-2">{{ form_widget(articleForm.isPublished) }}{{ form_label(articleForm.isPublished) }}</div>
                                    <div class="flex items-center gap-2">{{ form_widget(articleForm.isUrgent) }}{{ form_label(articleForm.isUrgent) }}</div>
                                    <div class="flex items-center gap-2">{{ form_widget(articleForm.isVisible) }}{{ form_label(articleForm.isVisible) }}</div>
                                </div>
                                <div class="flex items-center gap-2 pt-2">
                                    <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-[#A7C7E7] text-white font-medium hover:bg-[#B8D4ED]">
                                        Publier
                                    </button>
                                    <button type="button" id="cancel-article-form" class="px-4 py-2 rounded-lg border border-[#E5E0D8] text-[#6B7280] hover:bg-white">
                                        Annuler
                                    </button>
                                </div>
                            {{ form_end(articleForm) }}
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-blue-700 mb-2">Pour écrire un article, veuillez vous <a href="{{ path('app_login') }}" class="text-blue-600 hover:text-blue-800 underline">connecter</a>.</p>
                </div>
            {% endif %}
        </div>
    </div>
    </div>

    <!-- Colonne droite : Articles du module -->
    <div class="w-full lg:flex-1 lg:min-w-0">
    {# Articles publiés #}
    {% set allBlogs = module.blogs %}
    {% set articles = allBlogs|filter(blog => blog.isPublished) %}

    {# Brouillons de l'utilisateur connecté #}
    {% set drafts = [] %}
    {% if app.user %}
        {% set drafts = allBlogs|filter(blog => (not blog.isPublished) and blog.user and blog.user.id == app.user.id) %}
    {% endif %}

    {# Filtre de recherche sur le titre #}
    {% if searchTerm is defined and searchTerm is not empty %}
        {% set articles = articles|filter(blog => blog.titre is not empty and (searchTerm|lower in blog.titre|lower)) %}
        {% if app.user %}
            {% set drafts = drafts|filter(blog => blog.titre is not empty and (searchTerm|lower in blog.titre|lower)) %}
        {% endif %}
    {% endif %}

    {% set hasResults = (articles|length > 0) or (app.user and drafts|length > 0) %}

    {% if hasResults %}
        <div>
            <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-4">
                <h2 class="text-xl font-semibold text-[#4B5563]">Articles publiés pour ce module</h2>
                <form method="get" action="{{ path('user_blog_module', { id: module.id }) }}" class="w-full md:w-80">
                    <label for="search-article" class="block text-sm font-medium text-[#6B7280] mb-1"></label>
                    <div class="relative">
                        <input
                            type="text"
                            id="search-article"
                            name="q"
                            value="{{ searchTerm ?? '' }}"
                            placeholder="Tapez un titre d'article..."
                            class="w-full rounded-lg border border-[#E5E0D8] px-3 py-2 pl-9 text-sm text-[#111827] placeholder-[#9CA3AF] focus:outline-none focus:ring-2 focus:ring-[#A7C7E7]"
                        >
                        <span class="absolute inset-y-0 left-2 flex items-center pointer-events-none text-[#9CA3AF]">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M11 18a7 7 0 100-14 7 7 0 000 14z" />
                            </svg>
                        </span>
                    </div>
                </form>
            </div>

            {# Liste des articles publiés #}
            {% if articles|length > 0 %}
            <div class="space-y-4">
                {% for article in articles|sort((a, b) => b.dateCreation <=> a.dateCreation) %}
                    <div class="bg-white rounded-xl border border-[#E5E0D8] p-6 hover:shadow-md transition-shadow relative">
                        <!-- Icônes d'action fixes dans le coin supérieur droit -->
                        <div class="absolute top-4 right-4 flex gap-2">
                            <a href="{{ path('user_blog_article_download', {'id': article.id}) }}"
                               class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-[#DCFCE7] text-[#15803D] hover:bg-[#BBF7D0] transition-colors focus:outline focus:ring-2 focus:ring-[#86EFAC]"
                               title="Télécharger l'article">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M8 12l4 4m0 0l4-4m-4 4V4" />
                                </svg>
                            </a>
                            {% if app.user and (article.user and article.user.id == app.user.id or is_granted('ROLE_ADMIN')) %}
                                <a href="{{ path('user_blog_edit_article', {'id': article.id, 'moduleId': module.id}) }}" class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-[#DBEAFE] text-[#1D4ED8] hover:bg-[#BFDBFE] transition-colors focus:outline focus:ring-2 focus:ring-[#93C5FD]" title="Modifier l'article">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </a>
                                <form method="post" action="{{ path('user_blog_delete_article', {'id': article.id, 'moduleId': module.id}) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cet article ?');" class="inline">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ article.id) }}">
                                    <button type="submit" class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-[#FEE2E2] text-[#DC2626] hover:bg-[#FECACA] transition-colors focus:outline focus:ring-2 focus:ring-[#FCA5A5]" title="Supprimer l'article">
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </form>
                            {% endif %}
                        </div>

                        <div class="pr-16">
                            <div class="flex items-start gap-3 mb-3">
                                <!-- Image de l'article en petit -->
                                {% if article.image %}
                                    <div class="flex-shrink-0">
                                        <img src="{{ asset(article.image) }}" alt="{{ article.titre }}" class="w-12 h-12 object-cover rounded-lg">
                                    </div>
                                {% endif %}
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-[#4B5563] mb-2">{{ article.titre }}</h3>
                                    <div class="flex items-center gap-4 text-sm text-[#6B7280] mb-3">
                                        <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full
                                            {% if article.type == 'recommandation' %}bg-blue-100 text-blue-800
                                            {% elseif article.type == 'plainte' %}bg-red-100 text-red-800
                                            {% elseif article.type == 'question' %}bg-yellow-100 text-yellow-800
                                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                                            {{ article.type|capitalize }}
                                        </span>
                                        {% if article.isUrgent %}
                                            <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Urgent</span>
                                        {% endif %}
                                        <span>Par {{ article.user ? article.user.email : 'Anonyme' }}</span>
                                        <span>Le {{ article.dateCreation|date('d/m/Y à H:i') }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="prose prose-[#4B5563] max-w-none">
                            <p class="text-[#4B5563] break-words whitespace-normal">{{ article.contenu|length > 200 ? (article.contenu|slice(0, 200) ~ '...') : article.contenu }}</p>
                            <div class="mt-3 flex justify-end">
                                <a href="{{ path('user_blog_show_article', {'id': article.id}) }}" class="inline-flex items-center gap-2 text-[#A7C7E7] hover:text-[#B8D4ED] font-medium text-sm focus:outline focus:ring-2 focus:ring-[#A7C7E7] rounded-lg">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                                    </svg>
                                    Lire la suite
                                </a>
                            </div>
                        </div>

                        {# --- Barre d'interaction de l'article --- #}
                        <div class="mt-4 pt-3 border-t border-[#F3F0EB] flex items-center gap-4 text-sm text-[#6B7280]">
                            {% set isOwnArticle = app.user and article.user and article.user.id == app.user.id %}
                            {% set isArticleSaved = article.id in (savedArticleIds|default([])) %}

                            {% if app.user and not isOwnArticle %}
                                <button type="button"
                                        class="article-favorite-btn inline-flex items-center justify-center w-10 h-10 rounded-full transition-colors {{ isArticleSaved ? 'bg-[#BE185D] text-white' : 'bg-[#FCE7F3] text-[#BE185D]' }} hover:bg-[#FBCFE8]"
                                        title="{{ isArticleSaved ? 'Retirer des favoris' : 'Ajouter aux favoris' }}"
                                        data-article-id="{{ article.id }}"
                                        data-saved="{{ isArticleSaved ? '1' : '0' }}"
                                        data-toggle-url="{{ path('favoris_article_toggle', {id: article.id}) }}"
                                        data-csrf="{{ csrf_token('toggle_article_favori_' ~ article.id) }}"
                                        data-login-url="{{ path('app_login') }}">
                                    <svg class="w-5 h-5" fill="{{ isArticleSaved ? 'currentColor' : 'none' }}" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                                    </svg>
                                </button>
                            {% endif %}

                            {# Commentaire - lien vers la page article #}
                            <a href="{{ path('user_blog_show_article', {id: article.id}) }}#commentaires" class="inline-flex items-center gap-2 text-[#0369A1]">
                                <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-[#DBEAFE] text-[#1D4ED8] hover:bg-[#BFDBFE] transition-colors">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM21 12c0 4.97-4.03 9-9 9a9.863 9.863 0 01-4.255-.949L3 21l1.395-3.72A8.971 8.971 0 013 12c0-4.97 4.03-9 9-9s9 4.03 9 9z" />
                                </svg>
                                </span>
                                <span class="min-w-[1.25rem] text-sm font-medium text-[#6B7280]">{{ article.commentaires|length }}</span>
                            </a>

                            {# Repost article #}
                            <button type="button" class="article-repost-btn inline-flex items-center justify-center w-10 h-10 rounded-full bg-[#E0F2FE] text-[#0369A1] hover:bg-[#BAE6FD] transition-colors" data-url="{{ url('user_blog_show_article', {id: article.id}) }}">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 1l4 4-4 4M3 11V9a4 4 0 014-4h14M7 23l-4-4 4-4M21 13v2a4 4 0 01-4 4H3" />
                                </svg>
                            </button>

                            {# Partage article #}
                            <button type="button" class="article-share-btn inline-flex items-center justify-center w-10 h-10 rounded-full bg-[#DCFCE7] text-[#15803D] hover:bg-[#BBF7D0] transition-colors" data-url="{{ url('user_blog_show_article', {id: article.id}) }}" data-title="{{ article.titre }}">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 8.25L19.5 12m0 0L15 15.75M19.5 12H9.75c-2.9 0-5.25 2.35-5.25 5.25" />
                                </svg>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% endif %}

            {# Section des brouillons de l'utilisateur connecté #}
            {% if app.user and drafts|length > 0 %}
                <div class="mt-8 pt-6 border-t border-[#E5E0D8]">
                    <h3 class="text-lg font-semibold text-[#4B5563] mb-4">Vos brouillons</h3>
                    <div class="space-y-4">
                        {% for article in drafts|sort((a, b) => b.dateCreation <=> a.dateCreation) %}
                            <div class="bg-white rounded-xl border border-dashed border-[#E5E0D8] p-6 hover:shadow-sm transition-shadow relative">
                                <div class="absolute top-4 right-4 flex gap-2">
                                    <span class="inline-flex items-center justify-center px-2 py-1 rounded-full bg-yellow-50 text-yellow-700 text-xs font-medium">
                                        Brouillon
                                    </span>
                                    <a href="{{ path('user_blog_edit_article', {'id': article.id, 'moduleId': module.id}) }}" class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-[#DBEAFE] text-[#1D4ED8] hover:bg-[#BFDBFE] transition-colors focus:outline focus:ring-2 focus:ring-[#93C5FD]" title="Modifier le brouillon">
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </a>
                                    <form method="post" action="{{ path('user_blog_delete_article', {'id': article.id, 'moduleId': module.id}) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce brouillon ?');" class="inline">
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ article.id) }}">
                                        <button type="submit" class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-[#FEE2E2] text-[#DC2626] hover:bg-[#FECACA] transition-colors focus:outline focus:ring-2 focus:ring-[#FCA5A5]" title="Supprimer le brouillon">
                                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </form>
                                </div>

                                <div class="pr-16">
                                    <div class="flex items-start gap-3 mb-3">
                                        {% if article.image %}
                                            <div class="flex-shrink-0">
                                                <img src="{{ asset(article.image) }}" alt="{{ article.titre }}" class="w-12 h-12 object-cover rounded-lg">
                                            </div>
                                        {% endif %}
                                        <div class="flex-1">
                                            <h4 class="text-lg font-semibold text-[#4B5563] mb-1">{{ article.titre }}</h4>
                                            <p class="text-sm text-[#6B7280] mb-2">Créé le {{ article.dateCreation|date('d/m/Y à H:i') }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="prose prose-[#4B5563] max-w-none">
                                    <p class="text-[#4B5563] break-words whitespace-normal">
                                        {{ article.contenu|length > 200 ? (article.contenu|slice(0, 200) ~ '...') : article.contenu }}
                                    </p>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    {% else %}
        <div class="bg-white rounded-xl border border-[#E5E0D8] p-8 text-center">
            {% if searchTerm is defined and searchTerm is not empty %}
                <p class="text-[#6B7280] mb-2">Aucun article (publié ou brouillon) ne correspond au titre « {{ searchTerm }} ».</p>
                <a href="{{ path('user_blog_module', { id: module.id }) }}" class="inline-flex items-center gap-2 text-sm text-[#A7C7E7] hover:text-[#B8D4ED] font-medium">
                    Réinitialiser la recherche
                </a>
            {% else %}
                <p class="text-[#6B7280] mb-4">Aucun article publié pour ce module.</p>
                <p class="text-sm text-[#9CA3AF]">Soyez le premier à écrire un article !</p>
            {% endif %}
        </div>
    {% endif %}
    </div>
    </div>
</article>
<script>
document.addEventListener('DOMContentLoaded', function () {

    /* ====== Toast helper ====== */
    function showToast(message, duration) {
        duration = duration || 2500;
        var toastEl = document.getElementById('toast-notification');
        var msgEl = document.getElementById('toast-message');
        if (!toastEl || !msgEl) return;
        msgEl.textContent = message;
        toastEl.classList.remove('hidden');
        clearTimeout(toastEl._timer);
        toastEl._timer = setTimeout(function () {
            toastEl.classList.add('hidden');
        }, duration);
    }

    /* ====== Article form toggle ====== */
    var toggleBtn = document.getElementById('toggle-article-form');
    var cancelBtn = document.getElementById('cancel-article-form');
    var panel = document.getElementById('article-form-panel');

    if (toggleBtn && panel) {
        toggleBtn.addEventListener('click', function () {
            var isHidden = panel.classList.contains('hidden');
            panel.classList.toggle('hidden');
            toggleBtn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
        });
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function () {
                panel.classList.add('hidden');
                toggleBtn.setAttribute('aria-expanded', 'false');
            });
        }
    }

    /* ====== Scroll to article form when validation errors ====== */
    var articleFormEl = document.getElementById('article-form');
    if (articleFormEl && (articleFormEl.querySelector('.text-red-600, .border-red-500, .text-red-700') || articleFormEl.querySelector('[role="alert"]'))) {
        document.getElementById('article-form-panel').classList.remove('hidden');
        if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'true');
        articleFormEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    /* ====== Module Heart = toggle favori ====== */
    var heartBtn = document.getElementById('module-heart-btn');
    if (heartBtn) {
        heartBtn.addEventListener('click', function () {
            var url = heartBtn.getAttribute('data-toggle-url');
            var csrf = heartBtn.getAttribute('data-csrf');
            var saved = heartBtn.getAttribute('data-saved') === '1';

            var formData = new FormData();
            formData.append('_token', csrf);

            fetch(url, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(function () {
                saved = !saved;
                heartBtn.setAttribute('data-saved', saved ? '1' : '0');
                var svg = heartBtn.querySelector('svg');
                if (saved) {
                    heartBtn.classList.remove('bg-[#FCE7F3]', 'text-[#BE185D]');
                    heartBtn.classList.add('bg-[#BE185D]', 'text-white');
                    svg.setAttribute('fill', 'currentColor');
                    heartBtn.title = 'Retirer des favoris';
                    showToast('Module enregistré !');
                } else {
                    heartBtn.classList.remove('bg-[#BE185D]', 'text-white');
                    heartBtn.classList.add('bg-[#FCE7F3]', 'text-[#BE185D]');
                    svg.setAttribute('fill', 'none');
                    heartBtn.title = 'Enregistrer le module';
                    showToast('Module retiré des favoris');
                }
            }).catch(function () {
                showToast('Erreur, veuillez réessayer');
            });
        });
    }

    /* ====== Article Heart = toggle favori ====== */
    document.querySelectorAll('.article-favorite-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
            var url = btn.getAttribute('data-toggle-url');
            var csrf = btn.getAttribute('data-csrf');
            var saved = btn.getAttribute('data-saved') === '1';
            var loginUrl = btn.getAttribute('data-login-url');

            if (!url || !csrf) return;

            var formData = new FormData();
            formData.append('_token', csrf);

            fetch(url, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(function (response) {
                    if (response.status === 401 && loginUrl) {
                        window.location.href = loginUrl;
                        return null;
                    }
                    return response.json().then(function (data) {
                        if (!response.ok) {
                            throw new Error(data && data.error ? data.error : 'Erreur');
                        }
                        return data;
                    });
                })
                .then(function (data) {
                    if (!data) return;
                    saved = !!data.saved;
                    btn.setAttribute('data-saved', saved ? '1' : '0');
                    var svg = btn.querySelector('svg');
                    if (saved) {
                        btn.classList.remove('bg-[#FCE7F3]', 'text-[#BE185D]');
                        btn.classList.add('bg-[#BE185D]', 'text-white');
                        if (svg) svg.setAttribute('fill', 'currentColor');
                        btn.title = 'Retirer des favoris';
                        showToast('Article ajouté aux favoris');
                    } else {
                        btn.classList.remove('bg-[#BE185D]', 'text-white');
                        btn.classList.add('bg-[#FCE7F3]', 'text-[#BE185D]');
                        if (svg) svg.setAttribute('fill', 'none');
                        btn.title = 'Ajouter aux favoris';
                        showToast('Article retiré des favoris');
                    }
                })
                .catch(function (error) {
                    showToast(error && error.message ? error.message : 'Erreur, veuillez réessayer');
                });
        });
    });

    /* ====== Module Share Panel ====== */
    var shareBtn = document.getElementById('share-module');
    var shareModal = document.getElementById('module-share-modal');
    var shareBackdrop = document.getElementById('module-share-backdrop');
    var closeShareBtn = document.getElementById('close-module-share');
    var copyLinkBtn = document.getElementById('share-copy-link');
    var nativeShareBtn = document.getElementById('share-native');
    var facebookShareBtn = document.getElementById('share-facebook');
    var messengerShareBtn = document.getElementById('share-messenger');

    var moduleShareUrl = shareBtn ? (shareBtn.getAttribute('data-share-url') || window.location.href) : window.location.href;
    var moduleShareTitle = shareBtn ? (shareBtn.getAttribute('data-share-title') || document.title) : document.title;
    var moduleShareText = shareBtn ? (shareBtn.getAttribute('data-share-text') || 'Je vous partage ce module.') : 'Je vous partage ce module.';

    function closeShareModal() {
        if (!shareModal) return;
        shareModal.classList.add('hidden');
    }

    function openShareModal() {
        if (!shareModal) return;
        shareModal.classList.remove('hidden');
    }

    async function copyShareLink() {
        try {
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(moduleShareUrl);
            } else {
                var tempInput = document.createElement('input');
                tempInput.value = moduleShareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
            }
            showToast('Lien copié !');
        } catch (e) {
            showToast('Impossible de copier le lien');
        }
    }

    if (shareBtn) {
        shareBtn.addEventListener('click', openShareModal);
    }
    if (closeShareBtn) closeShareBtn.addEventListener('click', closeShareModal);
    if (shareBackdrop) shareBackdrop.addEventListener('click', closeShareModal);

    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') closeShareModal();
    });

    if (copyLinkBtn) {
        copyLinkBtn.addEventListener('click', async function () {
            await copyShareLink();
        });
    }

    if (nativeShareBtn) {
        nativeShareBtn.addEventListener('click', async function () {
            try {
                if (navigator.share) {
                    await navigator.share({ title: moduleShareTitle, text: moduleShareText, url: moduleShareUrl });
                } else {
                    await copyShareLink();
                }
            } catch (e) {
                if (e.name !== 'AbortError') showToast('Partage annulé');
            }
        });
    }

    if (facebookShareBtn) {
        facebookShareBtn.addEventListener('click', function () {
            var fbUrl = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(moduleShareUrl);
            window.open(fbUrl, '_blank', 'noopener,noreferrer,width=650,height=700');
        });
    }

    if (messengerShareBtn) {
        messengerShareBtn.addEventListener('click', async function () {
            var messengerUrl = 'fb-messenger://share/?link=' + encodeURIComponent(moduleShareUrl);
            var isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || '');

            if (isMobile) {
                window.location.href = messengerUrl;
                setTimeout(async function () {
                    await copyShareLink();
                    showToast('Lien copié, collez-le dans Messenger');
                }, 700);
            } else {
                await copyShareLink();
                window.open('https://www.messenger.com/', '_blank', 'noopener,noreferrer');
            }
        });
    }

    /* ====== Module Repost ====== */
    var repostBtn = document.getElementById('repost-module');
    if (repostBtn) {
        repostBtn.addEventListener('click', async function () {
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(window.location.href);
                    showToast('Lien copié dans le presse-papier !');
                } else {
                    showToast('Copie non disponible');
                }
            } catch (e) {
                showToast('Erreur lors de la copie');
            }
        });
    }

    /* ====== Per-article Repost ====== */
    document.querySelectorAll('.article-repost-btn').forEach(function (btn) {
        btn.addEventListener('click', async function () {
            var url = btn.getAttribute('data-url');
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(url);
                    showToast('Lien de l\'article copié !');
                }
            } catch (e) {
                showToast('Erreur lors de la copie');
            }
        });
    });

    /* ====== Per-article Share ====== */
    document.querySelectorAll('.article-share-btn').forEach(function (btn) {
        btn.addEventListener('click', async function () {
            var url = btn.getAttribute('data-url');
            var title = btn.getAttribute('data-title');
            try {
                if (navigator.share) {
                    await navigator.share({ title: title, url: url });
                } else if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(url);
                    showToast('Lien copié !');
                }
            } catch (e) {
                if (e.name !== 'AbortError') showToast('Partage annulé');
            }
        });
    });
});
</script>
{% endblock %}
